<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0 maximum-scale=1">
    <title>Delivery Bot</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script> <!--–ü–æ–¥–∫–ª—é—á–∞–µ–º —Å–∫—Ä–∏–ø—Ç –æ—Ç —Ç–µ–ª–µ–≥—Ä–∞–º-->
    <script src="/delivery_bot/moder/static/js/collapsive.js"></script>
    <link rel="stylesheet" href="/delivery_bot/moder/static/css/main.css">
</head>

<body>
   <button type="button" class="collapsible"><b>–ú–µ–Ω—é</b></button>
   <div class="content_menu">
      <div class="div-menu-button"><a class="menu_button" type="button" href='/delivery_bot/'><b>–ó–∞–¥–∞–Ω–∏—è</b></a></div>
   </div>
   <div>
      <input type="checkbox" id="all" class="checkbox">
      <label for="all">–û—Ç–æ–±—Ä–∞–∂–∞—Ç—å –≤—Å–µ –∑–∞–¥–∞–Ω–∏—è</label>
    </div>
   <div id="main" class="div-buttons">
      
   </div>
   <div id="usercard">
      
   </div>
   <p class="hint">
      ‚úÖ - –í—ã–ø–æ–ª–Ω–µ–Ω–æ<br>
      ‚ö†Ô∏è - –û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è<br>
      ‚ùåÔ∏è - –ó–∞–±—Ä–∞–∫–æ–≤–∞–Ω–æ<br>
      üü¢ –ù–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ<br>
   </p>
   <p class="hint">–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –±–æ—Ç–∞</p> <!--–ü—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç-–ø–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏-->
</body>
<script>
    // TODO: —Å–¥–µ–ª–∞—Ç —Ñ–∏–ª—å—Ç—Ä –ø–æ –∑–∞–¥–∞–Ω–∏—è–º

   var xmlhttp = new XMLHttpRequest(); // –°–æ–∑–¥–∞—ë–º –æ–±—ä–µ–∫—Ç XMLHTTP
   xmlhttp.open('GET', '/delivery_bot/moder/validate', true); // –û—Ç–∫—Ä—ã–≤–∞–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
   xmlhttp.setRequestHeader('Content-Type', 'application/json'); // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–¥–∏—Ä–æ–≤–∫—É
   xmlhttp.send(); // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º POST-–∑–∞–ø—Ä–æ—Å
   xmlhttp.onreadystatechange = function() { // –ñ–¥—ë–º –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
   if (xmlhttp.readyState == 4) { // –û—Ç–≤–µ—Ç –ø—Ä–∏—à—ë–ª
     if(xmlhttp.status == 200) { // –°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –∫–æ–¥ 200 (—á—Ç–æ —Ö–æ—Ä–æ—à–æ)
       if(this.responseText == '0') location.replace('/delivery_bot/unauthorized');
     }
   }
   };


   let tg = window.parent.window.Telegram.WebApp; //–ø–æ–ª—É—á–∞–µ–º –æ–±—ä–µ–∫—Ç webapp —Ç–µ–ª–µ–≥—Ä–∞–º–∞

   tg.expand(); //—Ä–∞—Å—à–∏—Ä—è–µ–º –Ω–∞ –≤—Å–µ –æ–∫–Ω–æ
    window.parent.window.Telegram.WebApp.enableClosingConfirmation()

    function get_missions(all) {
    var xmlhttp = new XMLHttpRequest(); // –°–æ–∑–¥–∞—ë–º –æ–±—ä–µ–∫—Ç XMLHTTP
    xmlhttp.open('GET', '/delivery_bot/moder/get_missions' + (all == true ? '?all=1' : ''), true); // –û—Ç–∫—Ä—ã–≤–∞–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
    xmlhttp.setRequestHeader('Content-Type', 'application/json'); // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–¥–∏—Ä–æ–≤–∫—É
    xmlhttp.send(); // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º POST-–∑–∞–ø—Ä–æ—Å
    xmlhttp.onreadystatechange = function() { // –ñ–¥—ë–º –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
        if (xmlhttp.readyState == 4) { // –û—Ç–≤–µ—Ç –ø—Ä–∏—à—ë–ª
            if (xmlhttp.status == 200) { // –°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –∫–æ–¥ 200 (—á—Ç–æ —Ö–æ—Ä–æ—à–æ)
                json = JSON.parse(this.responseText);
                missions = document.getElementById("main");

                for (var i = 0; i < json.length; i++) {
                    item = document.createElement('a');
                    item.href = `/delivery_bot/moder/mission/${json[i][0]}`;
                    item.innerText = json[i][1];
                    item.className = 'button'
                    missions.appendChild(item);
                }
            }
            else if (xmlhttp.status == 401) location.replace('/delivery_bot/unauthorized');
        }};
    }

   get_missions();
   
   let allCheckbox = document.getElementById("all"); //–ø–æ–ª—É—á–∞–µ–º –∫–Ω–æ–ø–∫—É –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å/–¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å
   allCheckbox.addEventListener('change', function(){ //–≤–µ—à–∞–µ–º —Å–æ–±—ã—Ç–∏–µ –Ω–∞ –Ω–∞–∂–∞—Ç–∏–µ html-–∫–Ω–æ–ø–∫–∏
      document.getElementById("main").innerHTML = '';
      get_missions(allCheckbox.checked);
   });

   let usercard = document.getElementById("usercard"); //–ø–æ–ª—É—á–∞–µ–º –±–ª–æ–∫ usercard
   let profName = document.createElement('p'); //—Å–æ–∑–¥–∞–µ–º –ø–∞—Ä–∞–≥—Ä–∞—Ñ
   profName.innerText = `${tg.initDataUnsafe.user.first_name}
   ${tg.initDataUnsafe.user.username}`;
   //–≤—ã–¥–µ–º –∏–º—è, "—Ñ–∞–º–∏–ª–∏—é", —á–µ—Ä–µ–∑ —Ç–∏—Ä–µ username –∏ –∫–æ–¥ —è–∑—ã–∫–∞
   usercard.appendChild(profName); //–¥–æ–±–∞–≤–ª—è–µ–º

   add_coll_listener()
</script>
</html>